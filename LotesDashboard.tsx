<LONG CODE OMITTED FOR BREVITY>